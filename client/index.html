<input type="file" id="input">
<br />
<label for="hash-progress-bar">制作hash进度条：</label>
<progress id="hash-progress-bar" value="0" max="0"></progress>

<hr />
<button id="upload" disabled>上传</button>
<label for="upload-progress-bar">上传进度条：</label>
<progress id="upload-progress-bar" value="0" max="0"></progress>
<hr />
<button id="pause">暂停</button>
<button id="continue">继续</button>
<hr />
<button id="reset">清空</button>


<script src="./modules/spark-md5.min.js"></script>
<script type="module">
    import { calculateHash, createChunk } from './js/helper.js'
    import { noticeMerge, getShouldUpload, uploadData } from './js/fetch-api.js'

    // 变量
    const SLICE_SIZE = 2 * 1024 * 1024 // 切片大小
    let pauseController = new AbortController()
    let data = {
        file: {}, // 上传文件
        chunkList: [], // 切片列表
        chunkHashs: [],
        fileHash: '',
    }
    let inputDom, uploadBtnDom, hashProgressDom, uploadProgressDom, resetDom, pauseDom, continueBtnDom
    window.data = data // 方便调试
    registerEventHandler() // 绑定事件监听器

    function registerEventHandler() {
        inputDom = document.getElementById('input')
        uploadBtnDom = document.getElementById('upload')
        hashProgressDom = document.getElementById('hash-progress-bar')
        uploadProgressDom = document.getElementById('upload-progress-bar')
        resetDom = document.getElementById('reset')
        pauseDom = document.getElementById('pause')
        continueBtnDom = document.getElementById('continue')

        // 读取文件
        inputDom.addEventListener('change', handleFileChange)
        // 文件上传
        uploadBtnDom.addEventListener('click', handleClickUpload)
        // reset
        resetDom.addEventListener('click', handleReset)
        // 暂停
        pauseDom.addEventListener('click', handlePause)
        // 继续上传，按普通上传处理，防止数据丢失
        continueBtnDom.addEventListener('click', handleClickUpload)
    }

    async function handleFileChange(e) {
        data.file = e.target.files[0]
        uploadProgressDom.max = data.file.size
        data.chunkList = createChunk(data.file, SLICE_SIZE)

        hashProgressDom.max = 100
        const hashResult = await calculateHash({
            fileChunkList: data.chunkList,
            onProgress: (percentage) => hashProgressDom.value = percentage,
        })
        data.fileHash = hashResult.fileHash
        data.chunkHashs = hashResult.chunkHashs
        uploadBtnDom.disabled = false
    }

    async function handleClickUpload() {
        // 通知后端去做切片合并
        async function uploadFile(chunkList) {
            const requestList = chunkList.map(({ file }, index) => ({
                file,
                chunkName: `${data.chunkHashs[index]}-${index}`,
                fileHash: data.fileHash,
                index
            }))
                .map(({ file, fileHash, index, chunkName }) => {
                    const formData = new FormData() // 创建表单类型数据
                    formData.append('file', file)//该文件
                    formData.append('fileHash', fileHash)//文件名
                    formData.append('chunkName', chunkName)//切片名
                    return { formData, index }
                })
                .map(({ formData, index }) => {
                    return new Promise(async resolve => {
                        await uploadData(formData, pauseController.signal)
                        //显示每个切片上传进度
                        uploadProgressDom.value += SLICE_SIZE
                        resolve()
                    })
                })
            await Promise.all(requestList)//保证所有的切片都已经传输完毕
        }

        const shouldUpload = await getShouldUpload(data.file.name, data.fileHash)
        if (!shouldUpload) {
            uploadProgressDom.value = uploadProgressDom.max = 100
            alert('妙传成功')
            return
        }
        //发请求，调用函数
        await uploadFile(data.chunkList)

        //当所有切片上传成功之后，通知后端合并
        await noticeMerge(data.file.name, data.fileHash, SLICE_SIZE)
        alert('上传成功')
    }

    function handlePause() {
        continueBtnDom.hidden = false
        pauseController.abort()
        pauseController = new AbortController() // reset pauseController
    }

    function handleReset() {
        data = {
            file: {},
            chunkList: [],
            chunkHashs: [],
            fileHash: ''
        }
        inputDom.value = ''
        hashProgressDom.value = 0
        uploadProgressDom.value = 0
        continueBtnDom.hidden = true
    }
</script>