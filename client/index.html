<input type="file" id="input">
<button id="upload">上传</button>
<!-- 上传进度 -->
<p>
    <label for="progress-bar">进度条：</label>
    <progress id="progress-bar" value="0" max="0"></progress>
</p>
<p>
    <button id="clearData">清空</button>
</p>


<script src="./modules/axios.min.js"></script>
<script src="./modules/spark-md5.min.js"></script>
<script>
    // 变量
    const SLICE_SIZE = 2 * 1024 * 1024 // 切片大小
    let data = {
        file: {}, // 上传文件
        chunkList: [] // 切片列表
    }

    let inputDom = document.getElementById('input')
    let uploadDom = document.getElementById('upload')
    let progressDom = document.getElementById('progress-bar')
    let stateDom = document.getElementById('upload-state')

    const axiosRequest = axios.create({
        baseURL: 'http://localhost:3000/',
        timeout: 5000,
        headers: 'Content-Type:application/x-www-form-urlencoded',
    });

    // 读取文件
    inputDom.addEventListener('change', handleFileChange)
    // 文件上传
    uploadDom.addEventListener('click', handleClickUpload)

    function handleFileChange(e) {
        data.file = e.target.files[0]
        progressDom.max = data.file.size
        // console.log(data.file);

        //创建切片
        data.chunkList = createChunk(data.file)
        // console.log(chunkList);

        function createChunk(file, size = SLICE_SIZE) {
            const chunkList = []
            let cur = 0
            while (cur < file.size) {
                chunkList.push({
                    file: file.slice(cur, cur + size)
                })
                cur += size
            }
            return chunkList
        }
    }

    async function handleClickUpload() {
        const uploadList = data.chunkList.map(({ file }, index) => ({
            file,
            size: file.size,
            percent: 0,
            chunkName: `${data.file.name}-${index}`,
            fileName: data.file.name,
            index
        }))
        //发请求，调用函数
        await uploadFile(uploadList)

        // 生成文件 hash（web-worker）
        function calculateHash(fileChunkList) {
            return new Promise(resolve => {
                // 添加 worker 属性
                workerworker = new Worker("./js/hash.js");
                workerworker.postMessage({ fileChunkList });
                workerworker.onmessage = e => {
                    const { percentage, hash } = e.data;
                    console.log(percentage)
                    if (hash) {
                        resolve(hash);
                    }
                }
            })
        }
    }

    //数据处理
    async function uploadFile(list) {
        const requestList = list.map(({ file, fileName, index, chunkName }) => {
            const formData = new FormData() // 创建表单类型数据
            formData.append('file', file)//该文件
            formData.append('fileName', fileName)//文件名
            formData.append('chunkName', chunkName)//切片名
            return { formData, index }
        })
            .map(({ formData, index }) => axiosRequest({
                method: 'post',
                url: 'upload',//请求接口，要与后端一一一对应
                data: formData
            })
                .then(res => {
                    //显示每个切片上传进度
                    progressDom.value += SLICE_SIZE
                })
            )
        await Promise.all(requestList)//保证所有的切片都已经传输完毕

        //当所有切片上传成功之后，通知后端合并
        merge(data.file.size, data.file.name)

        // 通知后端去做切片合并
        function merge(size, fileName) {
            axiosRequest({
                method: 'post',
                url: 'http://localhost:3000/merge',//后端合并请求
                data: JSON.stringify({
                    size: SLICE_SIZE,
                    fileName
                }),
            })
        }
    }

</script>